#!/usr/bin/python
# virustotal.com/en/documentation/public-api/

import requests
import sys
import getopt
import os
import datetime

apiKey ="81f543ae98a2d6480e65bac29396a1914ebe45cb71b63014a17d8f2eb11f44a6"
parameters = {'apikey':apiKey}


# make a post request and upload the file to be scanned to VirusTotal
def sendFileRequest(fileNameIn):
    if os.path.isfile(fileNameIn) == False:
        print("error, no such file: %s" % fileNameIn)
        sys.exit(2)

    filesIn = {'file': (fileNameIn, open(fileNameIn, 'rb'))}

    print("Checking VirusTotal for file: %s..." % fileNameIn)

    response = requests.post('https://www.virustotal.com/vtapi/v2/file/scan', files=filesIn, params=parameters)

    if response.status_code == 200:
        return response.json()
    else:
        print("Problem contacting VirusTotal - %d" % response.status_code)
        sys.exit(2)



# make a get request with the 'resource' provided by the initial upload
# to retrieve the results of the scan
def retrieveFileScanReport(resourceIn):
    parameters['resource'] = resourceIn
    headers = {
            "Accept-Encoding":"gzip, deflate",
            "User-Agent":"gzip, MalwareCheck"
            }

    print("Checking for report...")
    response = requests.get("https://www.virustotal.com/vtapi/v2/file/report", params=parameters, headers=headers)

    if response.status_code == 200:
        return response.json()
    else:
        print("Problem contacting VirusTotal - %d" % response.status_code)
        sys.exit(2)


# take in the report and format the output for the user
def printReport(responseIn):
    result = ""
    for scanLine, scanVals in responseIn[u'scans'].iteritems():
        if scanVals[u'detected'] == True:
            result = result + scanLine + ":\n\t" + scanVals[u'update'] + " | " + scanVals[u'result'] + "\n"

    return result


# pass in the relevent args like a boss
def main(argv):
    usage = "Usage: MalwareCheck -i <inputFileName> [-o <outputFileName>]"
    writeToFile = None

    try:
        opts, args = getopt.getopt(argv,"hi:o:",[])
    except getopt.GetoptError:
        print(usage)
        sys.exit(2)

    # people need to know how it works right?
    for opt,arg in opts:
        if opt == "-h":
            print(usage)
            sys.exit(2)
        elif opt == "-i":
            fileName = arg
            res = sendFileRequest(fileName)
        elif opt == "-o":
            if len(arg) == 0:
                print("No valid filename given")
                print(usage)
                sys.exit(2)
            else:
                writeToFile=arg
        else:
            print(usage)
            sys.exit(2)


    # we have the response to the file upload, so lets update user on what's happening
    response_code = res[u'response_code']
    if response_code == 0:
        print("Item not present in VirusTotal dataset")
        sys.exit(2)
    elif response_code == 1:
        print("File queued for scanning...")
    else:
        print(res[u'verbose_msg'])
        sys.exit(2)

    # grab the relevant info from the response dict
    resource = res[u'resource']
    scanId = res[u'scan_id']
    hashResult = res[u'sha256']

    # attempt to retrieve scan results
    res = retrieveFileScanReport(resource)
    
    # obtain the results contained within the report
    output = printReport(res)

    # deal with output
    if writeToFile is not None:
        if os.path.isfile(writeToFile) == False:
            f = open(writeToFile, "w+")
        else:
            print("file %s already exists, creating new..." % writeToFile)
            now = datetime.datetime.now()
            datestamp = now.strftime("%Y%m%d%H%M%S")
            fName = "MalwareCheck_" + datestamp + ".txt"
            f = open(fName, "w+")
            writeToFile = fName

        f.write(output)
        f.close
        print("output file %s created!" % writeToFile)
    else:
        print("\n------------------------------------------------------\n")
        if len(output) == 0:
            print("No matches found!")
        else:
            print(output)



if __name__ == "__main__":
    main(sys.argv[1:])
